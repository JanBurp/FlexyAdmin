
function doGrid(){$(".upload").click(function(){path=get_subclass("path_",$(this));dialog.html('<form class="upload" method="post" action="'+site_url("admin/filemanager/upload/"+path)+'" enctype="multipart/form-data">'+'<input type="file" name="file" value="" class="filemanager" /></form>');$(dialog).dialog({title:langp("dialog_title_upload"),modal:true,width:400,buttons:({cancel:function(){$(dialog).dialog("close");},upload:function(){uploadFile=$('.ui-dialog input.filemanager').val();backslash=uploadFile.lastIndexOf('\\');if(backslash>0)uploadFile=uploadFile.substr(backslash+1);$('.ui-dialog .ui-dialog-buttonpane').add('.ui-dialog a').add('.ui-dialog form').hide();$('.ui-dialog .ui-dialog-content').prepend("Uploading '<i>"+uploadFile+"</i>' <img src='"+site_url("sys/flexyadmin/assets/icons/wait.gif")+"' align='right' />");$("form.upload").submit();}}),close:function(){$(dialog).dialog("destroy");}});changeButt("cancel",lang("dialog_cancel"));changeButt("upload",lang("dialog_upload"));});isSortable=isGrid;if(isGrid||isFile){if($("table.grid").width()<600){$("table.grid").css({width:"600px"});}
$("table.grid td.self_parent").each(function(){var html=$(this).html();var parent_id=html.substring(1,html.indexOf(" ")-1);if(parent_id!=0){$(this).parent("tr").addClass("parent_id_"+parent_id);var title=$(this).nextAll("td.str:first");var titleHtml=$(title).html();var tree=titleHtml.split('/');var treeDepth=tree.length-1;var newHtml='';for(var i=0;i<treeDepth-1;i++){newHtml+='<span class="emptynode">&nbsp;</span>';};newHtml+='<span class="lastnode">&nbsp;</span>'+tree[treeDepth];$(title).html(newHtml);}});if($.browser.safari)
$("table.grid .self_parent").add("table.grid .uri").addClass('hiddenCell').show();else
$("table.grid .self_parent").hide();filter=$("table.grid:first");if(filter.length>0&&!isGridAction){if($(filter).hasClass('pagination')){var search=$(filter).attr('search');$("tr.caption:first tr").append('<td class="filter"><span class="help '+config.help_filter+'"><input class="filter" type="text" value="'+search+'"/></span></div>');var filterBox=$('input.filter');$(filterBox).keypress(function(e){if(e.which==keyEnter){var search=$(this).val();var url=$(filter).attr('url')+'/0/order/'+$(filter).attr('order')+'/search/'+search;location.href=url;}});}
else{w=$(filter).width();$(filter).width(w);if(isFile&&!isGrid){affects='tbody tr .file';}else{affects='tbody tr';}
$(filter).filterable({affects:affects,queryCss:'filter'},function(keyCode){rowsEvenOdd();switch(keyCode){case keyEnter:if(!$('.grid').hasClass('files')){select=$('.grid: tr.current');if(select.length==0){select=$('.grid tbody tr:first');}
id=get_id(select);table=get_table(select);url=site_url('admin/show/form/'+table+':'+id);location.href=url;}
break;case keyUp:setCurrent('up');break;case keyDown:setCurrent('down');break;default:setCurrent('first');}});filter_input=$("div.filter:first input");$(filter_input).addClass("filter").attr({title:'search / filter'});$("tr.caption:first tr").append('<td class="filter">');$("td.filter:first").html(filter_input);$("td.filter:first input").wrap('<span class="help '+config.help_filter+'"></span>');}}
if(isFile&&isThumbs){delButton=$('table.grid thead div.delete');delButtons=$('table.grid tbody div.file div.toolbar span div.delete');selButton=$('table.grid thead div.select');selButtons=$('table.grid tbody div.file div.toolbar span div.select');}
else{delButton=$('table.grid thead div.delete');delButtons=$('table.grid tbody tr div.delete');selButton=$('table.grid thead div.select');selButtons=$('table.grid tbody tr div.select');}
function lightDeleteButton(){var active=0;if(isFile&&isThumbs)
active=$('table.grid tbody div.file.selected').length;else
active=$('table.grid tbody tr.selected').length;if(active>0)
$(delButton).removeClass('inactive');else
$(delButton).addClass('inactive');}
$(selButtons).click(function(){if($(this).hasClass('selected')){$(this).removeClass('selected');$(this).parents('.selected').removeClass('selected');}
else{$(this).addClass('selected');if(isFile&&isThumbs)
$(this).parents('div.file').addClass('selected');else
$(this).parents('tr').addClass('selected');}
lightDeleteButton();});$(selButton).click(function(){$(selButtons).toggleClass('selected');if(isFile&&isThumbs)
$('.grid tbody div.file').toggleClass('selected');else
$('.grid tbody tr').toggleClass('selected');lightDeleteButton();});$("table.grid thead div.delete").add('table.thumbs thead div.delete').addClass('inactive').add(delButtons).click(function(){if($(this).hasClass('item')){$(selButtons).removeClass('selected');$('.grid .selected').removeClass('selected');if(isFile&&isThumbs){$(this).parents('.toolbar').find('.select').addClass('selected');$(this).parents('.file').addClass('selected');}
else{$(this).parents('td').find('.select').addClass('selected');$(this).parents('tr').addClass('selected');}
lightDeleteButton();}
clean_message();var id=new Array();var name=new Array();nr=0;if(isFile&&isThumbs)
selected=$('table.thumbs tbody div.file.selected:not(.filtered)');else
selected=$('table.grid tbody tr.selected:not(.filtered)');if(selected.length>0){$(selected).each(function(){id[nr]=get_id($(this));name[nr]=get_name($(this));if(name[nr]=="")name[nr]="id:"+id[nr];nr++;});if(isFile){var path='';if(isThumbs)
path=$('table.grid tbody div.file div.path').first().text();else
path=$('table.grid tbody tr td.thumb div.path').first().text();uri=site_url('admin/filemanager/confirm/'+path);}
else{table=get_table($('table.grid tbody tr:first'));uri=site_url('admin/edit/confirm/'+table);}
confirm_dialog(uri,name,id);}});if(isFile){$('tbody div.icon.edit').click(function(){if(isThumbs)
fileObj=$(this).parents('div.file:first');else
fileObj=$(this).parents('tr:first');var filename=$(fileObj).children('.name:first').text();path=$(fileObj).children('.thumb:first').children('.path:first').text();ext=get_ext(filename);shortName=filename.replace('.'+ext,'');var filedate=$(fileObj).find('.date:first .hidden').text();filedate=filedate.replace(/ /g,'-');var title=$(fileObj).find('.str_title:first').text();var dialogHtml='<form id="dialogform" method="post" action="'+site_url()+'admin/filemanager/rename/'+pathencode(path)+'/current/'+filename+get_current_grid_page_uri()+'">';if(title!='')dialogHtml+='<input id="title" name="title" value="'+title+'" /><br/><br/>';dialogHtml+='<input id="name" name="name" value="'+shortName+'" />.'+ext+'<br/>'+'<input type="hidden" name="ext" value="'+ext+'"/>'+'<input type="hidden" name="path" value="'+path+'"/>'+'<input type="hidden" name="file" value="'+shortName+'"/>';if(filedate!='')dialogHtml+='<br/><input id="date" name="date" value="'+filedate+'"/>';dialogHtml+='</form>';dialog.html(dialogHtml);$('input#date').datepicker({dateFormat:'yy-mm-dd'});$('#ui-datepicker-div').css({'z-index':2000});$(dialog).dialog({title:langp('dialog_title_rename',filename),modal:true,width:500,buttons:({cancel:function(){$(dialog).dialog("destroy");},ok:function(){$('.ui-dialog .ui-dialog-buttonpane').add('.ui-dialog a').hide();$('.ui-dialog .ui-dialog-content').append("<img src='"+site_url("sys/flexyadmin/assets/icons/wait.gif")+"' align='right' />");var data=$("#dialogform").serialize();$.post("admin/filemanager/edit/",data,function(data,status){window.location.reload()});}}),close:function(){$(dialog).dialog("destroy");}});changeButt("cancel",lang("dialog_cancel"));changeButt("ok",lang("dialog_ok"));});}}
if(isGrid&&!isFile){bFields=$(".grid td.b");$(bFields).click(function(){obj=this;cell=get_cell($(this));id=cell.id;if($(this).children("div:first").hasClass("no")){value="1";}else{value="0";}
url=site_url("admin/ajax/edit/"+cell.table+"/"+cell.id+"/"+cell.field+"/"+value);$(this).css('cursor','wait');$.post(url,"",function(data){if(data!=""){ajaxError(data);}
else{html=$(obj).html();if(value=="1")
html=html.replace(/no/g,"yes");else
html=html.replace(/yes/g,"no");$(obj).html(html);$(obj).css('cursor','pointer');}});})
if($("table.grid .order").length>0){help=$("table.grid tbody td.order:first span.help");if(help.length>0){help='help_'+get_subclass("help_",$(help));$("table.grid tbody td.order").empty().append('<span class="help '+help+'"><div class="icon order" title="order"></div></span>');$("table.grid thead th.order").empty();}
$("table.grid tbody tr:first td").each(function(){if($(this).css("display")=="none")w=0;else w=$(this).width()+"px";nr=get_nr($(this));$("table.grid tbody tr td.nr"+nr).css({width:w});});items=$("table.grid tbody");startPos=0;$(items).sortable({grid:[25,1],handle:'td.order',cursor:'move',appendTo:"body",forceHelperSize:true,forcePlaceholderSize:true,start:function(event,ui){id=get_id($(ui.item));if(hide_branches(id)){$(ui.helper).children("td.str:first").addClass("foldednode");}
$("table.grid tbody tr").removeClass("current");},sort:function(event,ui){if(startPos==0){startPos=ui.position.left;}},stop:function(event,ui){show_branches(id);$(ui.item).children().removeClass("foldednode");},update:function(event,ui){table=$("table.grid").attr("class");table=table.replace("grid","");table=table.replace("pagination","");table=$.trim(table);id=get_id($(ui.item));endPos=ui.position.left;shifted=(endPos-startPos)/25;if($("table.grid tr td.self_parent").length>0){nextRow=$(ui.item).next("tr");if(nextRow.length>0){newParentId=get_subclass("parent_id_",$(nextRow));if(newParentId=="")newParentId=0;}
else
newParentId=0;if((newParentId==0)&&(shifted>0)){prevRow=$(ui.item).prev("tr");if(prevRow.length>0){newParentId=get_id($(prevRow));if(newParentId=="")newParentId=0;}}
if(newParentId>=0){parentId=get_subclass("parent_id_",$(ui.item));$("table.grid tbody tr#"+id).removeClass("parent_id_"+parentId);if(newParentId>0)$("table.grid tbody tr#"+id).addClass("parent_id_"+newParentId);if(shifted>0)
shiftNodes(id,1);else{SpanNodes=$("table.grid tbody tr#"+id+" td.str:first").children(".emptynode");nextRow=$("table.grid tbody tr#"+id).next("tr");nextSpanNodes=$(nextRow).children("td.str:first").children(".emptynode");if(SpanNodes.length!=nextSpanNodes.length){shiftNodes(id,nextSpanNodes.length-SpanNodes.length,newParentId);}}
url=site_url("admin/ajax/edit/"+table+"/"+id+"/self_parent/"+newParentId+"/0");$.get(url,"",function(data){if(data!=""){ajaxError(data);}});}}
show_branches(id);$(ui.item).addClass("current");ser=serialize("table.grid tbody tr");url=site_url("admin/ajax/order/"+table);$.post(url,ser,function(data){if(data!=""){ajaxError(data);}
else{rowsEvenOdd();}});}});$("table.grid tbody").attr("style","");isSortable=false;}
else{isSortable=true;}}
if(isSortable&&$('table.bulkupload').length<1){grid=$("table.grid");if($(grid).hasClass('pagination')){$(grid).find('tr.heading th').each(function(){if(!$(this).hasClass('edit')){$(this).addClass('header').click(function(){if(isFile)
var field=get_class($(this),0);else
var field=get_class($(this),1);if($(this).hasClass('headerSortDown'))field='_'+field;var url=$(grid).attr('url')+'/0/order/'+field+'/search/'+$(grid).attr('search');location.href=url;});}});$(grid).find('li.pager a').each(function(){var order=$(grid).attr('order');if(order=='')order='name';var url=$(this).attr('href')+'/order/'+order+'/search/'+$(grid).attr('search');$(this).attr('href',url);});}
else{if($(grid).find('tbody tr').length>0){var cols=$(grid).find('tr.heading th');var sortcol=0;var desc=0;for(var i=0;i<cols.length;i++){if(($(cols[i]).hasClass('headerSortUp'))||($(cols[i]).hasClass('headerSortDown'))){sortcol=i;if($(cols[i]).hasClass('headerSortUp'))desc=1;}};$(grid).tablesorter({sortList:[[sortcol,desc]]});}
else
$(grid).tablesorter();$(grid).bind("sortStart",function(){$(grid).css("cursor","wait");});$(grid).bind("sortEnd",function(){$(grid).css("cursor","default");rowsEvenOdd();});}}
if(isGridAction){totalActions=$('.actionGrid td.id').html('<div class="icon no" /></div').length;actionNr=0;$('.actionGrid thead table tr:first td:first').before('<td>&nbsp;</td>').after('<td id="actionCounter"></td>');$('#actionCounter').html(actionNr/totalActions*100+' %');$('.actionGrid tbody tr:first').each(function(){doAction($(this));});}
function doAction(obj){$(obj).children('td.id:first').html('<div class="icon wait" /></div>');uri=$(obj).children('td.uri').html();if(uri!=''){$.ajax({type:"POST",url:uri,async:'false',success:function(data){if(data!=""){ajaxError(data);}
else{$(obj).children('td.id:first').html('<div class="icon yes" /></div');$(obj).next('tr:first').each(function(){actionNr++;$('#actionCounter').html(((actionNr+1)/totalActions*100).toFixed(1)+' %');doAction($(this));});}},error:function(){$(obj).children('td.id:first').html('<div class="icon no" /></div');$(obj).next('tr:first').each(function(){actionNr++;$('#actionCounter').html(((actionNr+1)/totalActions*100).toFixed(1)+' %');doAction($(this));});}});}}};function get_current_grid_page_uri(){var grid=$('table.grid');return'/offset/'+$(grid).attr('offset')+'/order/'+$(grid).attr('order')+'/search/'+$(grid).attr('search');}
function hide_branches(parent_id){var id;var hidden=false;$("table.grid tbody tr.parent_id_"+parent_id).each(function(){hidden=true;id=get_id($(this));hide_branches(id);$(this).hide().addClass("hidden_branch");});return hidden;}
function show_branches(id){$("table.grid tbody tr.hidden_branch").clone().show().removeClass("hidden_branch").addClass("current").insertAfter("table.grid tbody tr#"+id);$("table.grid tbody tr.hidden_branch").remove();}
function shiftNodes(id,add,newParentId){var n,empty,last;if(add<0){for(n=add;n<0;n++){$("table.grid tbody tr#"+id+" td.str:first span.emptynode:first").remove();$("table.grid tbody tr.hidden_branch").each(function(){$(this).children("td").children("span.emptynode:first").remove();});}
empty=$("table.grid tbody tr#"+id+" td.str:first span.emptynode").length;if(empty==0)$("table.grid tbody tr#"+id+" td.str:first span.lastnode").remove();}
if(add>0){emptyNode="<span class=\"emptynode\">&nbsp;</span>";last=$("table.grid tbody tr#"+id+" td.str span.lastnode").length;if(last==0){$("table.grid tbody tr#"+id).addClass("parent_id_"+newParentId);$("table.grid tbody tr#"+id+" td.str:first").prepend("<span class=\"lastnode\">&nbsp;</span>");}
for(n=0;n<add;n++){$("table.grid tbody tr#"+id+" td.str span.lastnode").before(emptyNode);$("table.grid tbody tr.hidden_branch").each(function(){$(this).children("td.str").children("span.lastnode").before(emptyNode);});}}}