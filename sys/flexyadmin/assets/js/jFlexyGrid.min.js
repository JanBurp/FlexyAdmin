function doGrid(){$(".upload").click(function(){path=get_subclass("path_",$(this));dialog.html('<form class="upload" method="post" action="'+site_url("admin/filemanager/upload/"+path)+'" enctype="multipart/form-data"><input type="file" name="file" value="" class="filemanager" /></form>');$(dialog).dialog({title:langp("dialog_title_upload"),modal:true,width:400,buttons:({cancel:function(){$(dialog).dialog("close")},upload:function(){uploadFile=$(".ui-dialog input.filemanager").val();backslash=uploadFile.lastIndexOf("\\");if(backslash>0){uploadFile=uploadFile.substr(backslash+1)}$(".ui-dialog .ui-dialog-buttonpane").add(".ui-dialog a").add(".ui-dialog form").hide();$(".ui-dialog .ui-dialog-content").prepend("Uploading '<i>"+uploadFile+"</i>' <img src='"+site_url("sys/flexyadmin/assets/icons/wait.gif")+"' align='right' />");$("form.upload").submit()}}),close:function(){$(dialog).dialog("destroy")}});changeButt("cancel",lang("dialog_cancel"));changeButt("upload",lang("dialog_upload"))});isSortable=isGrid;if(isGrid||isFile){if($("table.grid").width()<600){$("table.grid").css({width:"600px"})}$("table.grid td.self_parent").each(function(){html=$(this).html();if(html.length>0){parent_id=html.substring(1,html.indexOf(" ")-1);$(this).parent("tr").addClass("parent_id_"+parent_id);if(html.indexOf("/")<0){newHtml='<span class="emptynode">&nbsp;</span>'}else{newHtml='<span class="emptynode">&nbsp;</span>'+html;newHtml=newHtml.replace(/[^\/]*\//g,'<span class="emptynode">&nbsp;</span>');newHtml=newHtml.substr(0,newHtml.lastIndexOf(">")+1)}}next=$(this).parent("tr").children("td.str:first");if(html.length>0){newHtml=newHtml+'<span class="lastnode">&nbsp;</span>'+$(next).html()}else{newHtml=$(next).html()}$(next).html(newHtml)});if($.browser.safari){$("table.grid .self_parent").add("table.grid .uri").addClass("hiddenCell").show()}else{$("table.grid .self_parent").hide()}filter=$("table.grid:first");if(filter.length>0&&!isGridAction){if($(filter).hasClass("pagination")){var b=$(filter).attr("search");$("tr.caption:first tr").append('<td class="filter"><span class="help '+config.help_filter+'"><input class="filter" type="text" value="'+b+'"/></span></div>');$("input.filter").change(function(){var i=$(this).val();var h=$(filter).attr("url")+"/0/order/"+$(filter).attr("order")+"/search/"+i;location.href=h})}else{w=$(filter).width();$(filter).width(w);if(isFile&&!isGrid){affects="tbody tr .file"}else{affects="tbody tr"}$(filter).filterable({affects:affects,queryCss:"filter"},function(h){rowsEvenOdd();switch(h){case keyEnter:if(!$(".grid").hasClass("files")){select=$(".grid: tr.current");if(select.length==0){select=$(".grid tbody tr:first")}id=get_id(select);table=get_table(select);url=site_url("admin/show/form/"+table+":"+id);location.href=url}break;case keyUp:setCurrent("up");break;case keyDown:setCurrent("down");break;default:setCurrent("first")}});filter_input=$("div.filter:first input");$(filter_input).addClass("filter").attr({title:"search / filter"});$("tr.caption:first tr").append('<td class="filter">');$("td.filter:first").html(filter_input);$("td.filter:first input").wrap('<span class="help '+config.help_filter+'"></span>')}}if(isFile&&isThumbs){delButton=$("table.grid thead div.delete");delButtons=$("table.grid tbody div.file div.toolbar span div.delete");selButton=$("table.grid thead div.select");selButtons=$("table.grid tbody div.file div.toolbar span div.select")}else{delButton=$("table.grid thead div.delete");delButtons=$("table.grid tbody tr div.delete");selButton=$("table.grid thead div.select");selButtons=$("table.grid tbody tr div.select")}function e(){var h=0;if(isFile&&isThumbs){h=$("table.grid tbody div.file.selected").length}else{h=$("table.grid tbody tr.selected").length}if(h>0){$(delButton).removeClass("inactive")}else{$(delButton).addClass("inactive")}}$(selButtons).click(function(){if($(this).hasClass("selected")){$(this).removeClass("selected");$(this).parents(".selected").removeClass("selected")}else{$(this).addClass("selected");if(isFile&&isThumbs){$(this).parents("div.file").addClass("selected")}else{$(this).parents("tr").addClass("selected")}}e()});$(selButton).click(function(){$(selButtons).toggleClass("selected");if(isFile&&isThumbs){$(".grid tbody div.file").toggleClass("selected")}else{$(".grid tbody tr").toggleClass("selected")}e()});$("table.grid thead div.delete").add("table.thumbs thead div.delete").addClass("inactive").add(delButtons).click(function(){if($(this).hasClass("item")){$(selButtons).removeClass("selected");$(".grid .selected").removeClass("selected");if(isFile&&isThumbs){$(this).parents(".toolbar").find(".select").addClass("selected");$(this).parents(".file").addClass("selected")}else{$(this).parents("td").find(".select").addClass("selected");$(this).parents("tr").addClass("selected")}e()}clean_message();var j=new Array();var h=new Array();nr=0;if(isFile&&isThumbs){selected=$("table.thumbs tbody div.file.selected:not(.filtered)")}else{selected=$("table.grid tbody tr.selected:not(.filtered)")}if(selected.length>0){$(selected).each(function(){j[nr]=get_id($(this));h[nr]=get_name($(this));if(h[nr]==""){h[nr]="id:"+j[nr]}nr++});if(isFile){var i="";if(isThumbs){i=$("table.grid tbody div.file div.path").first().text()}else{i=$("table.grid tbody tr td.thumb div.path").first().text()}uri=site_url("admin/filemanager/confirm/"+i)}else{table=get_table($("table.grid tbody tr:first"));uri=site_url("admin/edit/confirm/"+table)}confirm_dialog(uri,h,j)}});if(isFile){$("tbody div.icon.edit").click(function(){if(isThumbs){fileObj=$(this).parents("div.file:first")}else{fileObj=$(this).parents("tr:first")}var i=$(fileObj).children(".name:first").text();path=$(fileObj).children(".thumb:first").children(".path:first").text();ext=get_ext(i);shortName=i.replace("."+ext,"");var h=$(fileObj).find(".date:first .hidden").text();h=h.replace(/ /g,"-");var j='<form method="post" action="'+site_url()+"admin/filemanager/rename/"+pathencode(path)+"/"+i+'"><input id="name" name="name" value="'+shortName+'" />.'+ext+'<br/><input type="hidden" name="ext" value="'+ext+'"/><input type="hidden" name="path" value="'+path+'"/>';if(h!=""){j+='<br/><input id="date" name="date" value="'+h+'"/>'}j+="</form>";dialog.html(j);$("input#date").datepicker({dateFormat:"yy-mm-dd"});$("#ui-datepicker-div").css({"z-index":2000});$(dialog).dialog({title:langp("dialog_title_rename",i),modal:true,width:500,buttons:({cancel:function(){$(dialog).dialog("destroy")},ok:function(){$(".ui-dialog .ui-dialog-buttonpane").add(".ui-dialog a").hide();$(".ui-dialog .ui-dialog-content").append("<img src='"+site_url("sys/flexyadmin/assets/icons/wait.gif")+"' align='right' />");newName=$(".ui-dialog input#name").attr("value")+"."+ext;var k=$(".ui-dialog input#date").attr("value");if(k!=undefined&&k!=""){h=k}location.replace(site_url("admin/filemanager/edit/"+pathencode(path)+"/"+i+"/"+newName+"/"+h))}}),close:function(){$(dialog).dialog("destroy")}});changeButt("cancel",lang("dialog_cancel"));changeButt("ok",lang("dialog_ok"))})}}if(isGrid&&!isFile){bFields=$(".grid td.b");$(bFields).click(function(){obj=this;cell=get_cell($(this));id=cell.id;if($(this).children("div:first").hasClass("no")){value="1"}else{value="0"}url=site_url("admin/ajax/edit/"+cell.table+"/"+cell.id+"/"+cell.field+"/"+value);$(this).css("cursor","wait");$.post(url,"",function(h){if(h!=""){ajaxError(h)}else{html=$(obj).html();if(value=="1"){html=html.replace(/no/g,"yes")}else{html=html.replace(/yes/g,"no")}$(obj).html(html);$(obj).css("cursor","pointer")}})});if($("table.grid .order").length>0){help=$("table.grid tbody td.order:first span.help");help="help_"+get_subclass("help_",$(help));$("table.grid tbody td.order").empty().append('<span class="help '+help+'"><div class="icon order" title="order"></div></span>');$("table.grid thead th.order").empty();$("table.grid tbody tr:first td").each(function(){if($(this).css("display")=="none"){w=0}else{w=$(this).width()+"px"}nr=get_nr($(this));$("table.grid tbody tr td.nr"+nr).css({width:w})});items=$("table.grid tbody");startPos=0;$(items).sortable({grid:[25,1],handle:"td.order",cursor:"move",appendTo:"body",forceHelperSize:true,forcePlaceholderSize:true,start:function(h,i){id=get_id($(i.item));if(hide_branches(id)){$(i.helper).children("td.str:first").addClass("foldednode")}$("table.grid tbody tr").removeClass("current")},sort:function(h,i){if(startPos==0){startPos=i.position.left}},stop:function(h,i){show_branches(id);$(i.item).children().removeClass("foldednode")},update:function(h,i){table=$("table.grid").attr("class");table=table.replace("grid","");table=table.replace("pagination","");table=$.trim(table);id=get_id($(i.item));endPos=i.position.left;shifted=(endPos-startPos)/25;if($("table.grid tr td.self_parent").length>0){nextRow=$(i.item).next("tr");if(nextRow.length>0){newParentId=get_subclass("parent_id_",$(nextRow));if(newParentId==""){newParentId=0}}else{newParentId=0}if((newParentId==0)&&(shifted>0)){prevRow=$(i.item).prev("tr");if(prevRow.length>0){newParentId=get_id($(prevRow));if(newParentId==""){newParentId=0}}}if(newParentId>=0){parentId=get_subclass("parent_id_",$(i.item));$("table.grid tbody tr#"+id).removeClass("parent_id_"+parentId);if(newParentId>0){$("table.grid tbody tr#"+id).addClass("parent_id_"+newParentId)}if(shifted>0){shiftNodes(id,1)}else{SpanNodes=$("table.grid tbody tr#"+id+" td.str:first").children(".emptynode");nextRow=$("table.grid tbody tr#"+id).next("tr");nextSpanNodes=$(nextRow).children("td.str:first").children(".emptynode");if(SpanNodes.length!=nextSpanNodes.length){shiftNodes(id,nextSpanNodes.length-SpanNodes.length,newParentId)}}url=site_url("admin/ajax/edit/"+table+"/"+id+"/self_parent/"+newParentId);$.get(url,"",function(j){if(j!=""){ajaxError(j)}})}}show_branches(id);$(i.item).addClass("current");ser=serialize("table.grid tbody tr");url=site_url("admin/ajax/order/"+table);$.post(url,ser,function(j){if(j!=""){ajaxError(j)}else{rowsEvenOdd()}})}});$("table.grid tbody").attr("style","");isSortable=false}else{isSortable=true}}if(isSortable&&$("table.bulkupload").length<1){grid=$("table.grid");if($(grid).hasClass("pagination")){$(grid).find("tr.heading th").each(function(){if(!$(this).hasClass("edit")){$(this).addClass("header").click(function(){if(isFile){var i=get_class($(this),0)}else{var i=get_class($(this),1)}if($(this).hasClass("headerSortDown")){i="_"+i}var h=$(grid).attr("url")+"/0/order/"+i+"/search/"+$(grid).attr("search");location.href=h})}});$(grid).find("span.pager a").each(function(){var h=$(grid).attr("order");if(h==""){h="name"}var i=$(this).attr("href")+"/order/"+h+"/search/"+$(grid).attr("search");$(this).attr("href",i)})}else{if($(grid).find("tbody tr").length>0){var f=$(grid).find("tr.heading th");var d=0;var g=0;for(var a=0;a<f.length;a++){if(($(f[a]).hasClass("headerSortUp"))||($(f[a]).hasClass("headerSortDown"))){d=a;if($(f[a]).hasClass("headerSortUp")){g=1}}}$(grid).tablesorter({sortList:[[d,g]]})}else{$(grid).tablesorter()}$(grid).bind("sortStart",function(){$(grid).css("cursor","wait")});$(grid).bind("sortEnd",function(){$(grid).css("cursor","default");rowsEvenOdd()})}}if(isGridAction){totalActions=$(".actionGrid td.id").html('<div class="icon no" /></div').length;actionNr=0;$(".actionGrid thead table tr:first td:first").before("<td>&nbsp;</td>").after('<td id="actionCounter"></td>');$("#actionCounter").html(actionNr/totalActions*100+" %");$(".actionGrid tbody tr:first").each(function(){c($(this))})}function c(h){$(h).children("td.id:first").html('<div class="icon wait" /></div>');uri=$(h).children("td.uri").html();if(uri!=""){$.ajax({type:"POST",url:uri,async:"false",success:function(i){if(i!=""){ajaxError(i)}else{$(h).children("td.id:first").html('<div class="icon yes" /></div');$(h).next("tr:first").each(function(){actionNr++;$("#actionCounter").html(((actionNr+1)/totalActions*100).toFixed(1)+" %");c($(this))})}},error:function(){$(h).children("td.id:first").html('<div class="icon no" /></div');$(h).next("tr:first").each(function(){actionNr++;$("#actionCounter").html(((actionNr+1)/totalActions*100).toFixed(1)+" %");c($(this))})}})}}}function hide_branches(b){var c;var a=false;$("table.grid tbody tr.parent_id_"+b).each(function(){a=true;c=get_id($(this));hide_branches(c);$(this).hide().addClass("hidden_branch")});return a}function show_branches(a){$("table.grid tbody tr.hidden_branch").clone().show().removeClass("hidden_branch").addClass("current").insertAfter("table.grid tbody tr#"+a);$("table.grid tbody tr.hidden_branch").remove()}function shiftNodes(f,d,a){var e,c,b;if(d<0){for(e=d;e<0;e++){$("table.grid tbody tr#"+f+" td.str:first span.emptynode:first").remove();$("table.grid tbody tr.hidden_branch").each(function(){$(this).children("td").children("span.emptynode:first").remove()})}c=$("table.grid tbody tr#"+f+" td.str:first span.emptynode").length;if(c==0){$("table.grid tbody tr#"+f+" td.str:first span.lastnode").remove()}}if(d>0){emptyNode='<span class="emptynode">&nbsp;</span>';b=$("table.grid tbody tr#"+f+" td.str span.lastnode").length;if(b==0){$("table.grid tbody tr#"+f).addClass("parent_id_"+a);$("table.grid tbody tr#"+f+" td.str:first").prepend('<span class="lastnode">&nbsp;</span>')}for(e=0;e<d;e++){$("table.grid tbody tr#"+f+" td.str span.lastnode").before(emptyNode);$("table.grid tbody tr.hidden_branch").each(function(){$(this).children("td.str").children("span.lastnode").before(emptyNode)})}}};